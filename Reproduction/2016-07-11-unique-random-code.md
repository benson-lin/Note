# 产生唯一随机码的方法分析

[转载地址](http://my.oschina.net/sukai/blog/705884)

1. **自己写代码**产生随机的数字和字母组合，每产生1个去数据库查询该随机码是否已存在，如果已存在，则重新产生，直到不重复为止。
优点：没发现有啥优点。     
缺点：产生速度慢，还要查询数据库，当数据量大的时候，可能重复的机率会比较高，要查询多次数据库.

2. **GUID**,该方法应该是用的比较多的。     
优点：使用简单方便，不用自己编写额外的代码     
缺点：占用数据库空间相对较大，特别是根据guid查询速度比较慢(毕竟是字符串)。

3. **主键+随机码**的方式，我们产生的随机码保存到数据库肯定会有个主键，用该主键+随机字符来组合。产生步骤：     
1) 先从id生成器中获取id，比如是155.     
2）填充成固定位数(比如8位)的字符串(不够位数的左边填0，超过位数直接使用该数字)，得到：00000155     
3）在每个数字后面随机插入1个字母或其它非数字符号，得到：0A0F0R0Y0H1K5L5M
这样就可以得到1个随机的唯一的邀请码了。    
优点：使用也比较简单，不用查询数据库。最大的优点是查询的时候，可以根据邀请码直接得到主键id，     然后根据id去数据库查询(速度很快)，再比较查询出来的邀请码和用户提交的邀请码是否一致。    
缺点：需要使用id产生器，如果主键是数据库自增长的就不太好用(需要先插入数据库获取id，再更新邀请码)。

4. 有时候产品经理说，我要求邀请码都是数字的。why？no why? 我喜欢。*(&^(^%&^$&^$ 把方法3变通下就可以实现唯一的纯数字随机码了。    
1) 获取id: 155    
2) 转换成8进制：233    
3) 转为字符串，并在后面加'9'字符：2339    
4）在后面随机产生若干个随机数字字符：2003967524987 ,转为8进制后就不会出现9这个字符，然后在后面加个'9'，这样就能确定唯一性。最后在后面产生一些随机数字就可以。这里简单认为随机字符串是(4987)，那么8进制是11573。结果就是(233911573),下面的例子中也是使用了类似的方式实现唯一性。
	优缺点同方法3

## 为什么第四种能保证唯一性

ID是唯一的，不然就不是ID了。那么ID不管转成几进制，它都是唯一的，为什么要加9呢？

注意这里还有一个后续的操作，就是后缀一个随机数，那么，假设我们用10进制，就可能会出现这样的情况

ID=15，R=56789，拼出来是156789
ID=155，R=6789，拼出来是156789
出现重复

解决办法是在ID和随机数R之间加一个分隔符，避免它们的混淆。

如果没要求随机码是数字，那这个分隔符好办，但看楼主的意思，这个随机码得是数字组成的，所以需要用一个不可能出现在ID中的数字来作为分隔符，所以……聪明人想到了8进制，因为8进制里没有8和9，可以用8或者9来作为分隔符。

当然，2-8进制都是可以的，但是2进制生成的验证码太长，3-7进制不常用，也没有现成的算法，所以就选了8进制了。如果要求随机码尽可能的短，那么用9进制平均会短一点……这都是题外话了。

现在，ID唯一，ID转换为8进制唯一，加上固定的分隔符8或者9（任选其一，但选定了就得一直使用，不能换了），再加上任意后缀，它都唯一。

仍然需要注意，为同一个ID生成的两个随机码有可能出现重复，不过随机码一般都是使用一次就丢弃，所以一般不会出现为一个ID生成两个随机码的情况，所以可以不考虑了。

## 一个栗子

题目是这样子的:

```
做为 Apple Store App 独立开发者，你要搞限时促销，为你的应用生成激活码（或者优惠券），使用 Python 如何生成 200 个激活码（或者优惠券）？
```

### 分析

其实要生成激活码(邀请码)也是很简单的事, 比如随机生成.或者使用GUID,UUID等,非常简单

但是我们得考虑存入以及验证的问题.

参考产生唯一随机码的方法分析。这篇文章的思路:

主键+随机码的方式.

这种方法优点：使用也比较简单，不用直接去查询数据库，而最大的优点是查询的时候，可以根据邀请码直接得到主键id, 然后根据id去数据库查询(速度很快)，再比较查询出来的邀请码和用户提交的邀请码是否一致。

生成:id(数据库primary key )->16进制 + "L(标识符)" +随机码
获取id:获取16进制的id再转回10进制



### 实现

```bash
#!/usr/bin/env python
# -*- coding: utf-8 -*-

import random
import string

def activation_code(id,length=10):
    '''
    id + L + 随机码
    string模块中的3个函数：string.letters，string.printable，string.printable
    '''
    prefix = hex(int(id))[2:]+ 'L'
    length = length - len(prefix)
    chars=string.ascii_letters+string.digits
    return prefix + ''.join([random.choice(chars) for i in range(length)])

def get_id(code):
    ''' Hex to Dec '''
    return str(int(code.upper(), 16))

if __name__=="__main__":
    for i in range(10,500,35):
        code = activation_code(i)
        id_hex = code.split('L')[0]
        id  = get_id(id_hex)
        print code,id
```

运行结果:
```bash
aLp5EzM4D2 10
2dL8TuFB2o 45
50LklqcpNp 80
73La8yOuo1 115
96LavIm2bS 150
b9LZd4PV3D 185
dcL05As00w 220
ffLeD0sy3C 255
122Lgi6YGs 290
145Ljin1B5 325
168L1k7ypr 360
18bL1RYoIE 395
1aeLaMAKrT 430
1d1LHbYL7X 465
```

## guid

全局唯一标识符（GUID，Globally Unique Identifier）是一种由算法生成的二进制长度为128位的数字标识符。GUID主要用于在拥有多个节点、多台计算机的网络或系统中。在理想情况下，任何计算机和计算机集群都不会生成两个相同的GUID。GUID 的总数达到了2^128（3.4×10^38）个，所以随机生成两个相同GUID的可能性非常小，但并不为0。GUID一词有时也专指微软对UUID标准的实现。